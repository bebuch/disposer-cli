<!--
Copyright (c) 2017 Benjamin Buch

https://github.com/bebuch/http

Distributed under the Boost Software License, Version 1.0. (See accompanying
file LICENSE_1_0.txt or copy at https://www.boost.org/LICENSE_1_0.txt)
-->
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<title>live view</title>
</head>
<body style="text-align:center;">
	<form>
		<fieldset style="display:inline-block;text-align:left;border:none;">
			<label style="display:inline-block;border:1px solid black;padding:0.5em;margin:0.2em 0;">
				<input type="radio" name="state" value="none" id="state_none" checked="checked">
				Aus
			</label>
			<label style="display:inline-block;border:1px solid black;padding:0.5em;margin:0.2em 0;">
				<input type="radio" name="state" value="show" id="state_show">
				Live
			</label>
			<label style="display:inline-block;border:1px solid black;padding:0.5em;margin:0.2em 0;">
				<input type="radio" name="state" value="save" id="state_save">
				Live mit speichern
			</label>
		</fieldset>
	</form>
	<canvas id="image"></canvas>
	<h1>live view</h1>
	<script>
		var radios = document.querySelectorAll('input[type=radio][name="state"]');

		var image = document.getElementById("image");
		var live_connection = false;
		var live_image = function(service_name){
			var socket = new WebSocket('ws://' + window.location.host + '/'
				+ service_name);
			socket.binaryType = 'arraybuffer';
			socket.onmessage = function(evt){
				console.log("onmessage");
				if(evt.data instanceof ArrayBuffer){
					var length = evt.data.byteLength;
					var blob = new Blob([evt.data],{type:'image/jpeg'});
					var url = URL.createObjectURL(blob);
					var img = new Image();
					img.onload = function(){
						var ctx = image.getContext("2d");
						if(image.width != img.width) image.width = img.width;
						if(image.height != img.height) image.height = img.height;
						ctx.drawImage(img, 0, 0);
					}
					img.src = url;
					socket.send(JSON.stringify({'ready': true}));
				}else if(typeof(evt.data) === 'string'){
					console.log("onmessage string: " + evt.data);
				}
			};
			socket.onopen = function(event){
				console.log("onopen: " + JSON.stringify(event));
				socket.send(JSON.stringify({'ready': true}));
			};
			socket.onerror = function(event){
				live_connection = false;
				console.log("onerror: " + JSON.stringify(event));
			};
			socket.onclose = function(event){
				console.log("onclose: " + JSON.stringify(event));
			};
			return socket;
		};

		var enable_change_events = function(){
			Array.prototype.forEach.call(radios, function(radio){
				radio.addEventListener('change', changeHandler);
			});
		};

		var disable_change_events = function(){
			Array.prototype.forEach.call(radios, function(radio){
				radio.removeEventListener('change', changeHandler);
			});
		};

		live_connection = live_image('scheduler');
		var command_socket = new WebSocket('ws://' + window.location.host + '/controller');
		command_socket.onmessage = function(evt){
			console.log("onmessage");
			if(typeof(evt.data) === 'string'){
				console.log("onmessage string: " + evt.data);
				var data = JSON.parse(evt.data);

				if(data.hasOwnProperty('token')){
					disable_change_events();
					document.getElementById("state_" + data.token).checked = true;
					enable_change_events();

					if(data.token != 'none'){
						live_connection = live_image('scheduler');
					}
				}else if(data.hasOwnProperty('chains')){
					disable_change_events();
					if(typeof(data.chains) === 'string' && data.chains === ''){
						document.getElementById("state_none").checked = true;
					}else if(Object.prototype.toString.call(data.chains) === '[object Array]'){
						if(data.chains.includes("show_live")){
							document.getElementById("state_show").checked = true;
						}else if(data.chains.includes("save_live")){
							document.getElementById("state_save").checked = true;
						}
					}
					enable_change_events();
				}else if(data.error){
					alert("Error: " + data.error);
				}
			}
		};
		command_socket.onopen = function(event){
			console.log("onopen: " + JSON.stringify(event));
		};
		command_socket.onerror = function(event){
			console.log("onerror: " + JSON.stringify(event));
		};
		command_socket.onclose = function(event){
			console.log("onclose: " + JSON.stringify(event));
		};


		function changeHandler(event){
			switch(this.value){
			case "none":
				console.log("click: none");
				command_socket.send(JSON.stringify({commands: [
						{chain: 'show_live', live: false},
						{chain: 'save_live', live: false}
					], token: 'none'}));
				break;
			case "show":
				console.log("click: show");
				command_socket.send(JSON.stringify({commands: [
						{chain: 'save_live', live: false},
						{chain: 'show_live', live: true}
					], token: 'show'}));
				break;
			case "save":
				console.log("click: save");
				command_socket.send(JSON.stringify({commands: [
						{chain: 'show_live', live: false},
						{chain: 'save_live', live: true}
					], token: 'save'}));
				break;
			}
		}

		enable_change_events();
	</script>
</body>
</html>
