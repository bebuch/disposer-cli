<!--
Copyright (c) 2017 Benjamin Buch

https://github.com/bebuch/http

Distributed under the Boost Software License, Version 1.0. (See accompanying
file LICENSE_1_0.txt or copy at https://www.boost.org/LICENSE_1_0.txt)
-->
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<title>live view</title>
</head>
<body style="text-align:center;">
	<form>
		<fieldset style="display:inline-block;text-align:left;border:none;">
			<label style="display:inline-block;border:1px solid black;padding:0.5em;margin:0.2em 0;">
				<input type="radio" name="state" value="none" id="none" checked="checked">
				Aus
			</label>
			<label style="display:inline-block;border:1px solid black;padding:0.5em;margin:0.2em 0;">
				<input type="radio" name="state" value="show_live" id="show_live">
				Live
			</label>
			<label style="display:inline-block;border:1px solid black;padding:0.5em;margin:0.2em 0;">
				<input type="radio" name="state" value="save_live" id="save_live">
				Live mit speichern
			</label>
		</fieldset>
	</form>
	<canvas id="image"></canvas>
	<h1>live view</h1>
	<button id="single_shot">single shot</button>
	<script>
		var radios = document.querySelectorAll('input[type=radio][name="state"]');

		var image = document.getElementById("image");
		var live_connection = false;
		var live_image = function(service_name){
			console.log("connect to live service '" + service_name + "'");
			var socket = new WebSocket('ws://' + window.location.host + '/'
				+ service_name);
			socket.binaryType = 'arraybuffer';
			socket.onmessage = function(evt){
				console.log("live onmessage");
				if(evt.data instanceof ArrayBuffer){
					var length = evt.data.byteLength;
					var blob = new Blob([evt.data],{type:'image/jpeg'});
					var url = URL.createObjectURL(blob);
					var img = new Image();
					img.onload = function(){
						var ctx = image.getContext("2d");
						if(image.width != img.width) image.width = img.width;
						if(image.height != img.height) image.height = img.height;
						ctx.drawImage(img, 0, 0);
					}
					img.src = url;
					socket.send('ready');
				}else if(typeof(evt.data) === 'string'){
					console.log("live onmessage string: " + evt.data);
				}
			};
			socket.onopen = function(event){
				console.log("live onopen: " + JSON.stringify(event));
				socket.send('ready');
			};
			socket.onerror = function(event){
				live_connection = false;
				console.log("live onerror: " + JSON.stringify(event));
			};
			socket.onclose = function(event){
				console.log("live onclose: " + JSON.stringify(event));
			};
			return socket;
		};

		var enable_change_events = function(){
			Array.prototype.forEach.call(radios, function(radio){
				radio.addEventListener('change', changeHandler);
			});
		};

		var disable_change_events = function(){
			Array.prototype.forEach.call(radios, function(radio){
				radio.removeEventListener('change', changeHandler);
			});
		};

		var command_socket = new WebSocket('ws://' + window.location.host + '/');
		command_socket.onmessage = function(evt){
			console.log("control onmessage");
			if(typeof(evt.data) === 'string'){
				console.log("control onmessage string: " + evt.data);
				var data = JSON.parse(evt.data);

				if(data.hasOwnProperty('running-chains')){
					disable_change_events();
					if(typeof(data['running-chains']) === 'string' && data['running-chains'] === ''){
						document.getElementById("none").checked = true;
					}else if(Object.prototype.toString.call(data['running-chains']) === '[object Array]'){
						if(data['running-chains'].includes("show_live")){
							document.getElementById("show_live").checked = true;
							live_connection = live_image('scheduler');
						}else if(data['running-chains'].includes("save_live")){
							document.getElementById("save_live").checked = true;
							live_connection = live_image('scheduler');
						}
					}
					enable_change_events();
				}else if(data.hasOwnProperty('run-chain')){
					if(typeof(data['run-chain']) !== 'string' || !['show_live', 'save_live'].includes(data['run-chain'])){
						console.log("unknown chain: ", JSON.stringify(data['run-chain']));
						return;
					}

					disable_change_events();
					document.getElementById(data['run-chain']).checked = true;
					enable_change_events();

					live_connection = live_image('scheduler');
				}else if(data.hasOwnProperty('stop-chain')){
					if(typeof(data['stop-chain']) !== 'string' || !['show_live', 'save_live'].includes(data['stop-chain'])){
						console.log("unknown chain: ", JSON.stringify(data['stop-chain']));
						return;
					}

					disable_change_events();
					document.getElementById("none").checked = true;
					enable_change_events();

					live_connection = false;
				}else if(data.error){
					alert("Error: " + data.error);
				}
			}
		};
		command_socket.onopen = function(event){
			console.log("control onopen: " + JSON.stringify(event));
		};
		command_socket.onerror = function(event){
			console.log("control onerror: " + JSON.stringify(event));
		};
		command_socket.onclose = function(event){
			console.log("control onclose: " + JSON.stringify(event));
		};


		var last_chain = 'none';
		function changeHandler(event){
			if(last_chain != 'none'){
				command_socket.send(JSON.stringify({chain: last_chain, live: false}));
				console.log("stop: ", last_chain);
			}

			if(this.value != 'none'){
				command_socket.send(JSON.stringify({chain: this.value, live: true}));
				console.log("run: ", this.value);
			}

			last_chain = this.value;
		};

		enable_change_events();

		var single_shot = document.getElementById("single_shot");
		single_shot.onclick = function(){
			command_socket.send(JSON.stringify({chain: 'show_live', exec: 1}));
			console.log("single shot");
		};
	</script>
</body>
</html>
